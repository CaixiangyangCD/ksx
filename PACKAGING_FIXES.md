# KSX桌面应用打包修复总结

## 修复的问题

### 1. Playwright浏览器依赖问题
**问题**: 爬虫运行时提示没有安装依赖，Playwright浏览器文件无法正确打包
**解决方案**: 
- 排除Playwright浏览器文件从打包中，让应用在运行时动态安装
- 修改桌面应用代码，在启动时自动检查并安装Playwright浏览器
- 使用应用内部目录存储浏览器文件

### 2. 导出文件路径问题
**问题**: 导出Excel时提示导出成功，但文件保存在项目目录而不是应用目录
**解决方案**:
- 创建`get_app_data_dir()`函数，支持打包后的应用路径
- 修改所有导出功能使用正确的应用内部目录
- 确保导出的文件保存在应用目录下的`data`文件夹中

### 3. 数据库路径问题
**问题**: 数据库文件路径在打包后不正确
**解决方案**:
- 修改`DatabaseManager`和`ConfigDatabaseManager`使用正确的路径
- 在打包后的应用中，数据库文件保存在应用目录下的`database`文件夹中

## 修复的文件

### 后端文件
- `backend/api/export.py` - 修复导出文件路径
- `backend/utils/excel_export.py` - 修复Excel导出路径
- `services/database_manager.py` - 修复数据库路径
- `services/config_database_manager.py` - 修复配置数据库路径

### 桌面应用文件
- `desktop/ksx_desktop_app.py` - 添加Playwright浏览器自动安装功能

### 构建脚本
- `build_simple.py` - 新的简化构建脚本，避免Playwright浏览器签名问题

## 使用方法

### 构建应用
```bash
# 使用简化的构建脚本
uv run python build_simple.py
```

### 安装应用
```bash
# 运行安装脚本
./install_macos.sh
```

### 直接运行
```bash
# 直接运行应用
open dist/KSX门店管理系统.app
```

## 应用特性

### 自包含性
- ✅ 应用完全自包含，不依赖外部环境
- ✅ 可以复制到任何目录直接运行
- ✅ 首次运行时会自动安装Playwright浏览器

### 数据存储
- ✅ 数据库文件保存在应用目录下的`database`文件夹
- ✅ 导出的文件保存在应用目录下的`data`文件夹
- ✅ 所有路径都是相对路径，支持应用移动

### 功能完整性
- ✅ 所有原始功能完全保留
- ✅ 爬虫功能正常工作
- ✅ 数据导出功能正常工作
- ✅ 门店配置和字段配置功能正常

## 注意事项

1. **首次运行**: 首次运行时会自动下载和安装Playwright浏览器，可能需要几分钟时间
2. **网络连接**: 首次运行需要网络连接来下载浏览器
3. **权限**: 应用需要写入权限来创建数据目录和安装浏览器
4. **存储空间**: 应用大小约240MB，加上浏览器文件总共约500MB

## 文件结构

```
KSX门店管理系统.app/
├── Contents/
│   ├── MacOS/
│   │   └── KSX门店管理系统 (主程序)
│   └── Resources/
│       ├── frontend/dist/ (前端文件)
│       ├── database/ (数据库文件)
│       ├── services/ (服务文件)
│       ├── backend/ (后端文件)
│       └── desktop/ (桌面应用文件)
├── playwright-browsers/ (运行时创建)
└── data/ (运行时创建，用于存储导出文件)
```

## 故障排除

### 如果爬虫无法运行
1. 检查网络连接
2. 删除应用目录下的`playwright-browsers`文件夹，重新启动应用
3. 确保应用有写入权限

### 如果导出文件找不到
1. 检查应用目录下的`data`文件夹
2. 确保应用有写入权限
3. 查看应用日志了解具体错误

### 如果应用无法启动
1. 检查系统是否支持该应用
2. 尝试在终端中运行查看错误信息
3. 确保所有依赖都已正确安装

