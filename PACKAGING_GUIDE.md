# KSX门店管理系统 - 打包部署指南

## 概述

本指南介绍如何将KSX门店管理系统打包成独立的可执行文件，用户无需安装Python环境或浏览器即可直接运行。

## 功能特性

✅ **完全自包含**：打包后的应用包含所有必要的依赖
✅ **自动环境检查**：启动时自动检查和安装Playwright浏览器
✅ **跨平台支持**：支持Windows (.exe) 和 macOS (.app)
✅ **零配置部署**：用户无需安装Python或浏览器

## 打包步骤

### 1. 环境准备

确保您的开发环境已安装：
- Python 3.8+
- uv (Python包管理器)
- Node.js 和 npm
- PyInstaller

```bash
# 安装PyInstaller
uv add pyinstaller
```

### 2. 执行打包

运行打包脚本：

```bash
python build.py
```

打包脚本会自动执行以下步骤：
1. 清理构建目录
2. 构建前端项目
3. 准备Python依赖
4. 创建PyInstaller配置文件
5. 使用PyInstaller构建应用
6. 创建安装脚本

### 3. 输出文件

打包完成后，您会在以下位置找到输出文件：

**Windows:**
- `dist/KSX门店管理系统/KSX门店管理系统.exe` - 主程序
- `install_windows.bat` - 安装脚本

**macOS:**
- `dist/KSX门店管理系统.app` - 应用程序包
- `install_macos.sh` - 安装脚本

## 部署说明

### Windows部署

1. 将整个 `dist/KSX门店管理系统/` 文件夹复制到目标机器
2. 运行 `install_windows.bat` 进行安装
3. 安装程序会自动：
   - 将应用安装到 `Program Files`
   - 创建桌面快捷方式
   - 创建开始菜单项

### macOS部署

1. 将 `KSX门店管理系统.app` 复制到目标机器
2. 运行 `install_macos.sh` 进行安装
3. 安装程序会自动：
   - 将应用复制到 `Applications` 文件夹
   - 设置正确的权限

## 自动环境检查

应用启动时会自动执行以下检查：

1. **Python环境检查**：验证Python版本
2. **Playwright检查**：检查Playwright是否已安装
3. **浏览器检查**：检查Chromium浏览器是否可用
4. **依赖检查**：验证所有必要的Python包
5. **环境设置**：配置必要的环境变量

如果检查失败，应用会：
- 自动尝试安装缺失的组件
- 显示详细的错误信息
- 提供解决建议

## 浏览器管理

### 自动安装

应用会自动将Playwright浏览器安装到项目目录下的 `playwright-browsers` 文件夹，确保：
- 浏览器文件与应用一起打包
- 不依赖系统已安装的浏览器
- 支持离线运行

### 浏览器路径

- **开发环境**：使用系统默认路径
- **打包环境**：使用应用目录下的 `playwright-browsers` 文件夹

## 故障排除

### 常见问题

1. **启动检查失败**
   - 检查网络连接（首次安装浏览器需要下载）
   - 确保有足够的磁盘空间
   - 检查防病毒软件是否阻止了安装

2. **浏览器启动失败**
   - 删除 `playwright-browsers` 文件夹，重新启动应用
   - 检查系统权限设置

3. **打包失败**
   - 确保所有依赖都已正确安装
   - 检查PyInstaller版本兼容性
   - 查看构建日志中的错误信息

### 调试模式

如果需要调试，可以：
1. 查看应用日志文件
2. 在开发环境中运行 `startup_check.py`
3. 检查浏览器管理器状态

## 技术架构

### 核心组件

- **BrowserManager**: 浏览器检测和安装管理
- **StartupCheckThread**: 启动检查线程
- **FastAPIThread**: 后端服务线程
- **FrontendServerThread**: 前端服务线程

### 文件结构

```
KSX门店管理系统/
├── KSX门店管理系统.exe (主程序)
├── playwright-browsers/ (浏览器文件)
├── frontend/dist/ (前端文件)
├── backend/ (后端代码)
├── services/ (服务模块)
└── database/ (数据库文件)
```

## 性能优化

### 启动优化

- 使用多线程进行环境检查
- 缓存浏览器安装状态
- 异步加载前端资源

### 资源优化

- 只打包必要的浏览器文件
- 压缩静态资源
- 使用UPX压缩可执行文件

## 安全考虑

- 所有浏览器文件都包含在应用包中
- 不依赖外部网络资源（除首次安装）
- 使用本地数据库存储配置
- 支持离线运行

## 更新机制

应用支持自动更新：
1. 检查新版本
2. 下载更新包
3. 自动替换文件
4. 重启应用

## 支持信息

如有问题，请：
1. 查看应用日志
2. 检查系统要求
3. 联系技术支持

---

**注意**：首次运行可能需要较长时间来下载和安装浏览器，请耐心等待。


